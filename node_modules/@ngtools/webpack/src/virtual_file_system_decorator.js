"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.NodeWatchFileSystem = require('webpack/lib/node/NodeWatchFileSystem');
class VirtualFileSystemDecorator {
    constructor(_inputFileSystem, _webpackCompilerHost) {
        this._inputFileSystem = _inputFileSystem;
        this._webpackCompilerHost = _webpackCompilerHost;
    }
    _readFileSync(path) {
        if (this._webpackCompilerHost.fileExists(path)) {
            return this._webpackCompilerHost.readFileBuffer(path) || null;
        }
        return null;
    }
    _statSync(path) {
        if (this._webpackCompilerHost.fileExists(path)) {
            return this._webpackCompilerHost.stat(path);
        }
        return null;
    }
    getVirtualFilesPaths() {
        return this._webpackCompilerHost.getNgFactoryPaths();
    }
    stat(path, callback) {
        const result = this._statSync(path);
        if (result) {
            callback(null, result);
        }
        else {
            this._inputFileSystem.stat(path, callback);
        }
    }
    readdir(path, callback) {
        this._inputFileSystem.readdir(path, callback);
    }
    readFile(path, callback) {
        const result = this._readFileSync(path);
        if (result) {
            callback(null, result);
        }
        else {
            this._inputFileSystem.readFile(path, callback);
        }
    }
    readJson(path, callback) {
        this._inputFileSystem.readJson(path, callback);
    }
    readlink(path, callback) {
        this._inputFileSystem.readlink(path, callback);
    }
    statSync(path) {
        const result = this._statSync(path);
        return result || this._inputFileSystem.statSync(path);
    }
    readdirSync(path) {
        return this._inputFileSystem.readdirSync(path);
    }
    readFileSync(path) {
        const result = this._readFileSync(path);
        return result || this._inputFileSystem.readFileSync(path);
    }
    readJsonSync(path) {
        return this._inputFileSystem.readJsonSync(path);
    }
    readlinkSync(path) {
        return this._inputFileSystem.readlinkSync(path);
    }
    purge(changes) {
        if (typeof changes === 'string') {
            this._webpackCompilerHost.invalidate(changes);
        }
        else if (Array.isArray(changes)) {
            changes.forEach((fileName) => this._webpackCompilerHost.invalidate(fileName));
        }
        if (this._inputFileSystem.purge) {
            this._inputFileSystem.purge(changes);
        }
    }
}
exports.VirtualFileSystemDecorator = VirtualFileSystemDecorator;
class VirtualWatchFileSystemDecorator extends exports.NodeWatchFileSystem {
    constructor(_virtualInputFileSystem) {
        super(_virtualInputFileSystem);
        this._virtualInputFileSystem = _virtualInputFileSystem;
    }
    watch(files, // tslint:disable-line:no-any
    dirs, // tslint:disable-line:no-any
    missing, // tslint:disable-line:no-any
    startTime, // tslint:disable-line:no-any
    options, // tslint:disable-line:no-any
    callback, // tslint:disable-line:no-any
    callbackUndelayed) {
        const newCallback = (err, // tslint:disable-line:no-any
        filesModified, // tslint:disable-line:no-any
        contextModified, // tslint:disable-line:no-any
        missingModified, // tslint:disable-line:no-any
        fileTimestamps, contextTimestamps) => {
            // Update fileTimestamps with timestamps from virtual files.
            const virtualFilesStats = this._virtualInputFileSystem.getVirtualFilesPaths()
                .map((fileName) => ({
                path: fileName,
                mtime: +this._virtualInputFileSystem.statSync(fileName).mtime,
            }));
            virtualFilesStats.forEach(stats => fileTimestamps[stats.path] = +stats.mtime);
            callback(err, filesModified, contextModified, missingModified, fileTimestamps, contextTimestamps);
        };
        return super.watch(files, dirs, missing, startTime, options, newCallback, callbackUndelayed);
    }
}
exports.VirtualWatchFileSystemDecorator = VirtualWatchFileSystemDecorator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlydHVhbF9maWxlX3N5c3RlbV9kZWNvcmF0b3IuanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL25ndG9vbHMvd2VicGFjay9zcmMvdmlydHVhbF9maWxlX3N5c3RlbV9kZWNvcmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFXYSxRQUFBLG1CQUFtQixHQUFpQyxPQUFPLENBQ3RFLHNDQUFzQyxDQUFDLENBQUM7QUFFMUM7SUFDRSxZQUNVLGdCQUFpQyxFQUNqQyxvQkFBeUM7UUFEekMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFpQjtRQUNqQyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXFCO0lBQy9DLENBQUM7SUFFRyxhQUFhLENBQUMsSUFBWTtRQUNoQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQyxNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUM7UUFDaEUsQ0FBQztRQUVELE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU8sU0FBUyxDQUFDLElBQVk7UUFDNUIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0MsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUMsQ0FBQztRQUVELE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsb0JBQW9CO1FBQ2xCLE1BQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztJQUN2RCxDQUFDO0lBRUQsSUFBSSxDQUFDLElBQVksRUFBRSxRQUF5QjtRQUMxQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMs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QUFFLGFBQWEsRUFBRSxlQUFlLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFDM0UsaUJBQWlCLENBQUMsQ0FBQztRQUN2QixDQUFDLENBQUM7UUFFRixNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO0lBQy9GLENBQUM7Q0FDRjtBQW5DRCwwRUFtQ0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5pbXBvcnQgeyBTdGF0cyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IFdlYnBhY2tDb21waWxlckhvc3QgfSBmcm9tICcuL2NvbXBpbGVyX2hvc3QnO1xuaW1wb3J0IHsgQ2FsbGJhY2ssIElucHV0RmlsZVN5c3RlbSwgTm9kZVdhdGNoRmlsZVN5c3RlbUludGVyZmFjZSB9IGZyb20gJy4vd2VicGFjayc7XG5cbmV4cG9ydCBjb25zdCBOb2RlV2F0Y2hGaWxlU3lzdGVtOiBOb2RlV2F0Y2hGaWxlU3lzdGVtSW50ZXJmYWNlID0gcmVxdWlyZShcbiAgJ3dlYnBhY2svbGliL25vZGUvTm9kZVdhdGNoRmlsZVN5c3RlbScpO1xuXG5leHBvcnQgY2xhc3MgVmlydHVhbEZpbGVTeXN0ZW1EZWNvcmF0b3IgaW1wbGVtZW50cyBJbnB1dEZpbGVTeXN0ZW0ge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIF9pbnB1dEZpbGVTeXN0ZW06IElucHV0RmlsZVN5c3RlbSxcbiAgICBwcml2YXRlIF93ZWJwYWNrQ29tcGlsZXJIb3N0OiBXZWJwYWNrQ29tcGlsZXJIb3N0LFxuICApIHsgfVxuXG4gIHByaXZhdGUgX3JlYWRGaWxlU3luYyhwYXRoOiBzdHJpbmcpOiBCdWZmZXIgfCBudWxsIHtcbiAgICBpZiAodGhpcy5fd2VicGFja0NvbXBpbGVySG9zdC5maWxlRXhpc3RzKHBhdGgpKSB7XG4gICAgICByZXR1cm4gdGhpcy5fd2VicGFja0NvbXBpbGVySG9zdC5yZWFkRmlsZUJ1ZmZlcihwYXRoKSB8fCBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBfc3RhdFN5bmMocGF0aDogc3RyaW5nKTogU3RhdHMgfCBudWxsIHtcbiAgICBpZiAodGhpcy5fd2VicGFja0NvbXBpbGVySG9zdC5maWxlRXhpc3RzKHBhdGgpKSB7XG4gICAgICByZXR1cm4gdGhpcy5fd2VicGFja0NvbXBpbGVySG9zdC5zdGF0KHBhdGgpO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZ2V0VmlydHVhbEZpbGVzUGF0aHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3dlYnBhY2tDb21waWxlckhvc3QuZ2V0TmdGYWN0b3J5UGF0aHMoKTtcbiAgfVxuXG4gIHN0YXQocGF0aDogc3RyaW5nLCBjYWxsYmFjazogQ2FsbGJhY2s8U3RhdHM+KTogdm9pZCB7XG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5fc3RhdFN5bmMocGF0aCk7XG4gICAgaWYgKHJlc3VsdCkge1xuICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdWx0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5faW5wdXRGaWxlU3lzdGVtLnN0YXQocGF0aCwgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIHJlYWRkaXIocGF0aDogc3RyaW5nLCBjYWxsYmFjazogQ2FsbGJhY2s8c3RyaW5nW10+KTogdm9pZCB7XG4gICAgdGhpcy5faW5wdXRGaWxlU3lzdGVtLnJlYWRkaXIocGF0aCwgY2FsbGJhY2spO1xuICB9XG5cbiAgcmVhZEZpbGUocGF0aDogc3RyaW5nLCBjYWxsYmFjazogQ2FsbGJhY2s8c3RyaW5nIHwgQnVmZmVyPik6IHZvaWQge1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuX3JlYWRGaWxlU3luYyhwYXRoKTtcbiAgICBpZiAocmVzdWx0KSB7XG4gICAgICBjYWxsYmFjayhudWxsLCByZXN1bHQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9pbnB1dEZpbGVTeXN0ZW0ucmVhZEZpbGUocGF0aCwgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIHJlYWRKc29uKHBhdGg6IHN0cmluZywgY2FsbGJhY2s6IENhbGxiYWNrPHt9Pik6IHZvaWQge1xuICAgIHRoaXMuX2lucHV0RmlsZVN5c3RlbS5yZWFkSnNvbihwYXRoLCBjYWxsYmFjayk7XG4gIH1cblxuICByZWFkbGluayhwYXRoOiBzdHJpbmcsIGNhbGxiYWNrOiBDYWxsYmFjazxzdHJpbmc+KTogdm9pZCB7XG4gICAgdGhpcy5faW5wdXRGaWxlU3lzdGVtLnJlYWRsaW5rKHBhdGgsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIHN0YXRTeW5jKHBhdGg6IHN0cmluZyk6IFN0YXRzIHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9zdGF0U3luYyhwYXRoKTtcblxuICAgIHJldHVybiByZXN1bHQgfHwgdGhpcy5faW5wdXRGaWxlU3lzdGVtLnN0YXRTeW5jKHBhdGgpO1xuICB9XG5cbiAgcmVhZGRpclN5bmMocGF0aDogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIHJldHVybiB0aGlzLl9pbnB1dEZpbGVTeXN0ZW0ucmVhZGRpclN5bmMocGF0aCk7XG4gIH1cblxuICByZWFkRmlsZVN5bmMocGF0aDogc3RyaW5nKTogc3RyaW5nIHwgQnVmZmVyIHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9yZWFkRmlsZVN5bmMocGF0aCk7XG5cbiAgICByZXR1cm4gcmVzdWx0IHx8IHRoaXMuX2lucHV0RmlsZVN5c3RlbS5yZWFkRmlsZVN5bmMocGF0aCk7XG4gIH1cblxuICByZWFkSnNvblN5bmMocGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5faW5wdXRGaWxlU3lzdGVtLnJlYWRKc29uU3luYyhwYXRoKTtcbiAgfVxuXG4gIHJlYWRsaW5rU3luYyhwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9pbnB1dEZpbGVTeXN0ZW0ucmVhZGxpbmtTeW5jKHBhdGgpO1xuICB9XG5cbiAgcHVyZ2UoY2hhbmdlcz86IHN0cmluZ1tdIHwgc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHR5cGVvZiBjaGFuZ2VzID09PSAnc3RyaW5nJykge1xuICAgICAgdGhpcy5fd2VicGFja0NvbXBpbGVySG9zdC5pbnZhbGlkYXRlKGNoYW5nZXMpO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShjaGFuZ2VzKSkge1xuICAgICAgY2hhbmdlcy5mb3JFYWNoKChmaWxlTmFtZTogc3RyaW5nKSA9PiB0aGlzLl93ZWJwYWNrQ29tcGlsZXJIb3N0LmludmFsaWRhdGUoZmlsZU5hbWUpKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2lucHV0RmlsZVN5c3RlbS5wdXJnZSkge1xuICAgICAgdGhpcy5faW5wdXRGaWxlU3lzdGVtLnB1cmdlKGNoYW5nZXMpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVmlydHVhbFdhdGNoRmlsZVN5c3RlbURlY29yYXRvciBleHRlbmRzIE5vZGVXYXRjaEZpbGVTeXN0ZW0ge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIF92aXJ0dWFsSW5wdXRGaWxlU3lzdGVtOiBWaXJ0dWFsRmlsZVN5c3RlbURlY29yYXRvcikge1xuICAgIHN1cGVyKF92aXJ0dWFsSW5wdXRGaWxlU3lzdGVtKTtcbiAgfVxuXG4gIHdhdGNoKFxuICAgIGZpbGVzOiBhbnksICAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOm5vLWFueVxuICAgIGRpcnM6IGFueSwgIC8vIHRzbGludDpkaXNhYmxlLWxpbmU6bm8tYW55XG4gICAgbWlzc2luZzogYW55LCAgLy8gdHNsaW50OmRpc2FibGUtbGluZTpuby1hbnlcbiAgICBzdGFydFRpbWU6IGFueSwgIC8vIHRzbGludDpkaXNhYmxlLWxpbmU6bm8tYW55XG4gICAgb3B0aW9uczogYW55LCAgLy8gdHNsaW50OmRpc2FibGUtbGluZTpuby1hbnlcbiAgICBjYWxsYmFjazogYW55LCAgLy8gdHNsaW50OmRpc2FibGUtbGluZTpuby1hbnlcbiAgICBjYWxsYmFja1VuZGVsYXllZDogYW55LCAgLy8gdHNsaW50OmRpc2FibGUtbGluZTpuby1hbnlcbiAgKSB7XG4gICAgY29uc3QgbmV3Q2FsbGJhY2sgPSAoXG4gICAgICBlcnI6IGFueSwgIC8vIHRzbGludDpkaXNhYmxlLWxpbmU6bm8tYW55XG4gICAgICBmaWxlc01vZGlmaWVkOiBhbnksICAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOm5vLWFueVxuICAgICAgY29udGV4dE1vZGlmaWVkOiBhbnksICAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOm5vLWFueVxuICAgICAgbWlzc2luZ01vZGlmaWVkOiBhbnksICAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOm5vLWFueVxuICAgICAgZmlsZVRpbWVzdGFtcHM6IHsgW2s6IHN0cmluZ106IG51bWJlciB9LFxuICAgICAgY29udGV4dFRpbWVzdGFtcHM6IHsgW2s6IHN0cmluZ106IG51bWJlciB9LFxuICAgICkgPT4ge1xuICAgICAgLy8gVXBkYXRlIGZpbGVUaW1lc3RhbXBzIHdpdGggdGltZXN0YW1wcyBmcm9tIHZpcnR1YWwgZmlsZXMuXG4gICAgICBjb25zdCB2aXJ0dWFsRmlsZXNTdGF0cyA9IHRoaXMuX3ZpcnR1YWxJbnB1dEZpbGVTeXN0ZW0uZ2V0VmlydHVhbEZpbGVzUGF0aHMoKVxuICAgICAgICAubWFwKChmaWxlTmFtZSkgPT4gKHtcbiAgICAgICAgICBwYXRoOiBmaWxlTmFtZSxcbiAgICAgICAgICBtdGltZTogK3RoaXMuX3ZpcnR1YWxJbnB1dEZpbGVTeXN0ZW0uc3RhdFN5bmMoZmlsZU5hbWUpLm10aW1lLFxuICAgICAgICB9KSk7XG4gICAgICB2aXJ0dWFsRmlsZXNTdGF0cy5mb3JFYWNoKHN0YXRzID0+IGZpbGVUaW1lc3RhbXBzW3N0YXRzLnBhdGhdID0gK3N0YXRzLm10aW1lKTtcbiAgICAgIGNhbGxiYWNrKGVyciwgZmlsZXNNb2RpZmllZCwgY29udGV4dE1vZGlmaWVkLCBtaXNzaW5nTW9kaWZpZWQsIGZpbGVUaW1lc3RhbXBzLFxuICAgICAgICBjb250ZXh0VGltZXN0YW1wcyk7XG4gICAgfTtcblxuICAgIHJldHVybiBzdXBlci53YXRjaChmaWxlcywgZGlycywgbWlzc2luZywgc3RhcnRUaW1lLCBvcHRpb25zLCBuZXdDYWxsYmFjaywgY2FsbGJhY2tVbmRlbGF5ZWQpO1xuICB9XG59XG4iXX0=